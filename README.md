
# Задача: Написать парсер для игр, стримеров и стримов Twich-a, а также для продуктов Lamod-ы по категориям.

**Предварительные действия для запуска проекта**
- Выполнить команду chmod -R 777 twich_lamoda_parser/tlparser/data/dev/elastic для develop среды
- Выполнить команду chmod -R 777 twich_lamoda_parser/tlparser/data/prd/elastic для production среды.
- Установить gnu make и docker + docker-compose

**Запуск проекта**
1. make devstart - запуск проекта в develop среде
2. make prdstart - запуск проекта в production среде
3. make parser_it - запуск интеграционных тестов для сервиса parser
4. make caller_it - запуск интеграционных тестов для сервиса caller
5. make parser_component - запуск компонентных тестов для сервиса parer.

**Закрытие проекта**
1. make devstop - закрытие проекта в develop среде.
2. make prdstop - закрытие проекта в production среде.
3. Тесты закрываются автоматически после того как будут выполнены.


**Архитектура на примере twich game**

1. **Сервис parser**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/parser_architecture.png)
Сервис построен по гексакональной архитектуре.
Есть 3 слоя: внешний (включает presentation и infrastructure), средний (включает application) и внутренний (включает domain).
Более внешний слой зависит от более внутреннего, но не наоборот.
Слой Domain реализует доменные сущности, доменные события, исключения, относящиеся к домену, также интерфейсы репозиториев и доменные сервисы.
Доменные сервисы содержат бизнес-логику, интерфейсы репозиториев описывают методы, которые должны быть у каждого репозитория.
Слой Application является свящующим слоем между Presentation & Domain. Он определяет сервисы приложения (Application services) и их интерфейсы.
Они вызывают доменные сервисы, внедренные репозитории и генераторы событий.
Слой infrastructure содержит реализации репозиториев, соединения с базами данных, брокерами сообщений, реализации генераторов событий.
Слой presentation содержит rest-контроллеры и обработчики событий.
Интерфейсы репозиториев, интерфейсы генераторов событий и интерфейсы сервисов приложений являются портами (выходящий, выходящий и входящий соответственно).
Реализации репозиториев, реализации генераторов события является выходящими адаптерами.
Контроллеры и обработчики событий являются входными адаптерами.
Зависимости:
api client > controller > iservice > (domain event, irepository, ipublisher) > (domain entity, domain entity, domain event).
kafka > event dispatcher > iservice > irepository > domain entity from domain event.
Контроллер зависит от инферфейсов, как и реализация сервисов приложений. Все реализации внедряются путем внедрения зависимостей.
Поэтому все зависимости идут в центр.

3. **Сервис caller**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/caller_architecture.png)
Сервис caller представляет собой обычный потребитель сообщий, котоырый потребляет сообщений от parser и вызывает его эндпоинты для парсинга данных.
Parser публикует события для caller, когда кто-то вызывает эндпоинт parse. В этот момент отправляется событие сервису caller, а он вызывает эндпоинт private_parse.
Эндпоинт parse является внешним и не парсит данные, а только отправляет события сервису caller, эндпоинт private_parse вызывается caller и непосредственно парсит данные.


**Описание потока выполнения при удалении сущности и при ее парсинге через caller (на примере twich game)**
1. **Create, Delete operations**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/parser_create_flow.png)
Данное описание соответстует моменту, когда сервис caller вызвал private_parse. Он описывает поток парсинга.
Сначала вызывается контроллер, который вызывает сервис приложений, который парсит данные (доменный сервис) и сохраняет их в монге (репозиторий).
Репозиторий возвращает доменное событие и сервис приложений вызывает генератор события для отправки события самому себе.
После этого он получает это событие и в обработчике событий и вызывает сервис приложений, который сохраняет данные в еластике, откуда читаются данные.

3. **Read operations**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/parser_read_flow.png)
Описыват поток чтения данных. Данные записываются в монгу, а читаются из эластика.


**Описание межсервисного взаимодействия**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/ipc.png)
Межпроцессное взаимодействие организовано через брокера (кафка). Стиль взаимодейтсвия: издатель/подписчик.
Есть 2 канала типа точка-точка. Первый канал caller. Туда сервис parser шлет события, когда вызывают его публичный метод parse.
Второй канал parser. Туда сервис parser шлет события в ответ на измненения доменных сущностей.


**Описание паттерна cqrs**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/cqrs.png)
В проекте реализован паттер cqrs, который разделяет доменную модуль запросов и команд.
Для команд используется монго в качестве бд, а для запросов эластик в качестве бд.

**Развертывания на примере среды production**
![Image alt](https://github.com/Twelvews/twich_lamoda_parser/raw/feature/initproject/images/deployment.png)
Описывает конейнеры на примере среды production.
